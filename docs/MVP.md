# Interview Conditioning Studio â€” MVP Plan

## Summary

A local-first, browser-based interview conditioning tool with:

- TypeScript core engine (compiled to JS)
- Pure JS/CSS web app
- Minimal dependencies (just for build tooling)

---

## Session Timing (Standard Preset)

| Phase      | Duration | Nudges      | Audio |
| ---------- | -------- | ----------- | ----- |
| PREP       | 5 min    | No          | No    |
| CODING     | 35 min   | Yes (3 max) | Yes   |
| SILENT     | 5 min    | No          | Yes   |
| SUMMARY    | â€”        | â€”           | No    |
| REFLECTION | â€”        | â€”           | No    |

**Total: 45 minutes + reflection (~60 seconds)**

---

## Session Presets

| Preset            | Prep  | Coding | Silent | Nudges | Intent                          |
| ----------------- | ----- | ------ | ------ | ------ | ------------------------------- |
| **Standard**      | 5 min | 35 min | 5 min  | 3      | Default experience              |
| **High Pressure** | 3 min | 25 min | 2 min  | 1      | Time compression + limited help |
| **No Assistance** | 5 min | 35 min | 5 min  | 0      | Full time, no nudges            |

Presets are predefined configurations. No custom configuration in MVP.

---

## Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              BROWSER                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                         WEB APP (TypeScript)                          â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚   app.ts    â”‚  â”‚  screens/   â”‚  â”‚  audio.ts   â”‚  â”‚  export.ts  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ Controller  â”‚  â”‚ Components  â”‚  â”‚ MediaRec.   â”‚  â”‚ tar.gz      â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚         â”‚                â”‚                â”‚                â”‚         â”‚  â”‚
â”‚  â”‚         â”‚    renders     â”‚                â”‚                â”‚         â”‚  â”‚
â”‚  â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚                â”‚         â”‚  â”‚
â”‚  â”‚         â”‚                                 â”‚                â”‚         â”‚  â”‚
â”‚  â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚  â”‚
â”‚  â”‚         â”‚  â”‚                              â”‚                â”‚         â”‚  â”‚
â”‚  â”‚         â–¼  â–¼                              â–¼                â–¼         â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ storage.ts  â”‚                   â”‚ Audio Blob  â”‚  â”‚ .tar.gz     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ IndexedDB   â”‚                   â”‚(webm/mp4)   â”‚  â”‚  (bundle)   â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                     â”‚  â”‚
â”‚  â”‚  â”‚ problems.ts â”‚  Hardcoded problem set                              â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â”‚                                                â”‚
â”‚                            â”‚ imports                                        â”‚
â”‚                            â–¼                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      CORE ENGINE (TypeScript)                         â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚                        index.ts (Public API)                    â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚         â”‚              â”‚              â”‚              â”‚                â”‚  â”‚
â”‚  â”‚         â–¼              â–¼              â–¼              â–¼                â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”‚
â”‚  â”‚  â”‚session.ts â”‚  â”‚ presets.tsâ”‚  â”‚  types.ts â”‚  â”‚           â”‚          â”‚  â”‚
â”‚  â”‚  â”‚           â”‚  â”‚           â”‚  â”‚           â”‚  â”‚           â”‚          â”‚  â”‚
â”‚  â”‚  â”‚ State     â”‚  â”‚ Standard  â”‚  â”‚ Shared    â”‚  â”‚           â”‚          â”‚  â”‚
â”‚  â”‚  â”‚ Machine   â”‚  â”‚ HighPress â”‚  â”‚ types     â”‚  â”‚           â”‚          â”‚  â”‚
â”‚  â”‚  â”‚ + Events  â”‚  â”‚ NoAssist  â”‚  â”‚           â”‚  â”‚           â”‚          â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚  â”‚
â”‚  â”‚              â”‚   Event Log     â”‚                                      â”‚  â”‚
â”‚  â”‚              â”‚   (in memory)   â”‚                                      â”‚  â”‚
â”‚  â”‚              â”‚                 â”‚                                      â”‚  â”‚
â”‚  â”‚              â”‚ â€¢ session.*     â”‚                                      â”‚  â”‚
â”‚  â”‚              â”‚ â€¢ prep.*        â”‚                                      â”‚  â”‚
â”‚  â”‚              â”‚ â€¢ coding.*      â”‚                                      â”‚  â”‚
â”‚  â”‚              â”‚ â€¢ nudge.*       â”‚                                      â”‚  â”‚
â”‚  â”‚              â”‚ â€¢ audio.*       â”‚                                      â”‚  â”‚
â”‚  â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## State Machine

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                          â”‚
                    â–¼                                          â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
              â”‚  START   â”‚                                     â”‚
              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                     â”‚
                   â”‚ user clicks "Start Session"               â”‚
                   â”‚ problem auto-selected                     â”‚
                   â–¼                                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
              â”‚   PREP   â”‚  5 min, SILENT                      â”‚
              â”‚          â”‚  â€¢ Read problem                     â”‚
              â”‚          â”‚  â€¢ Write invariants                 â”‚
              â”‚          â”‚  â€¢ No nudges                        â”‚
              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                     â”‚
                   â”‚                                           â”‚
                   â”‚ invariants submitted                      â”‚
                   â”‚ OR timer expires (warning â†’ force)        â”‚
                   â–¼                                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
              â”‚  CODING  â”‚  35 min, ACTIVE                     â”‚
              â”‚          â”‚  â€¢ Write code                       â”‚
              â”‚          â”‚  â€¢ Audio recording                  â”‚
              â”‚          â”‚  â€¢ Nudges allowed (3 max)           â”‚
              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                     â”‚
                   â”‚                                           â”‚
                   â”‚ 35 min elapsed                            â”‚
                   â–¼                                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
              â”‚  SILENT  â”‚  5 min, SILENT                      â”‚
              â”‚          â”‚  â€¢ Continue coding                  â”‚
              â”‚          â”‚  â€¢ No nudges                        â”‚
              â”‚          â”‚  â€¢ Audio continues                  â”‚
              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                     â”‚
                   â”‚                                           â”‚
                   â”‚ timer expires                             â”‚
                   â–¼                                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
              â”‚ SUMMARY  â”‚                                     â”‚
              â”‚          â”‚  â€¢ View stats                       â”‚
              â”‚          â”‚  â€¢ Review code & invariants         â”‚
              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                     â”‚
                   â”‚                                           â”‚
                   â”‚ user clicks "Continue"                    â”‚
                   â–¼                                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
              â”‚REFLECTIONâ”‚  Mandatory, ~60 seconds             â”‚
              â”‚          â”‚  â€¢ 5 recognition-based prompts      â”‚
              â”‚          â”‚  â€¢ Cannot skip                      â”‚
              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                     â”‚
                   â”‚                                           â”‚
                   â”‚ reflection submitted                      â”‚
                   â–¼                                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
              â”‚   DONE   â”‚                                     â”‚
              â”‚          â”‚  â€¢ Download bundle                  â”‚
              â”‚          â”‚  â€¢ Start new session                â”‚
              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                     â”‚
                   â”‚                                           â”‚
                   â”‚ user clicks "New Session"                 â”‚
                   â”‚                                           â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## File Structure

```
InterviewCondtioningStudio/
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ Architecture.md
â”‚   â”œâ”€â”€ PRD.md
â”‚   â”œâ”€â”€ MVP.md
â”‚   â”œâ”€â”€ USAGE.md
â”‚   â””â”€â”€ PRINCIPLES.md
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ index.ts        # Public API exports
â”‚   â”‚   â”œâ”€â”€ session.ts      # State machine, event dispatch
â”‚   â”‚   â”œâ”€â”€ presets.ts      # Preset configurations
â”‚   â”‚   â””â”€â”€ types.ts        # Type definitions
â”‚   â””â”€â”€ tests/
â”‚       â”œâ”€â”€ session.test.ts
â”‚       â”œâ”€â”€ phases.test.ts
â”‚       â”œâ”€â”€ validation.test.ts
â”‚       â”œâ”€â”€ recovery.test.ts
â”‚       â””â”€â”€ features.test.ts
â”œâ”€â”€ web/
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â””â”€â”€ styles.css      # Responsive CSS
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ main.ts         # Entry point
â”‚       â”œâ”€â”€ app.ts          # App controller
â”‚       â”œâ”€â”€ router.ts       # Hash-based routing
â”‚       â”œâ”€â”€ storage.ts      # IndexedDB wrapper
â”‚       â”œâ”€â”€ audio.ts        # MediaRecorder wrapper
â”‚       â”œâ”€â”€ tar.ts          # TAR file writer
â”‚       â”œâ”€â”€ export.ts       # Export as .tar.gz
â”‚       â”œâ”€â”€ problems.ts     # Hardcoded problem set
â”‚       â”œâ”€â”€ constants.ts    # Actions, components
â”‚       â”œâ”€â”€ types.ts        # Web-specific types
â”‚       â”œâ”€â”€ components/
â”‚       â”‚   â”œâ”€â”€ index.ts
â”‚       â”‚   â”œâ”€â”€ Button.ts
â”‚       â”‚   â”œâ”€â”€ Timer.ts
â”‚       â”‚   â”œâ”€â”€ PhaseHeader.ts
â”‚       â”‚   â”œâ”€â”€ PresetCard.ts
â”‚       â”‚   â”œâ”€â”€ ProblemCard.ts
â”‚       â”‚   â”œâ”€â”€ CodeEditor.ts
â”‚       â”‚   â”œâ”€â”€ InvariantsInput.ts
â”‚       â”‚   â”œâ”€â”€ InvariantsDisplay.ts
â”‚       â”‚   â”œâ”€â”€ NudgeButton.ts
â”‚       â”‚   â”œâ”€â”€ RecordingIndicator.ts
â”‚       â”‚   â”œâ”€â”€ Modal.ts
â”‚       â”‚   â””â”€â”€ Toast.ts
â”‚       â”œâ”€â”€ screens/
â”‚       â”‚   â”œâ”€â”€ index.ts
â”‚       â”‚   â”œâ”€â”€ types.ts
â”‚       â”‚   â”œâ”€â”€ HomeScreen.ts
â”‚       â”‚   â”œâ”€â”€ PrepScreen.ts
â”‚       â”‚   â”œâ”€â”€ CodingScreen.ts
â”‚       â”‚   â”œâ”€â”€ SummaryScreen.ts
â”‚       â”‚   â”œâ”€â”€ ReflectionScreen.ts
â”‚       â”‚   â””â”€â”€ DoneScreen.ts
â”‚       â””â”€â”€ modals/
â”‚           â””â”€â”€ index.ts
â”œâ”€â”€ e2e/
â”‚   â”œâ”€â”€ smoke.spec.ts
â”‚   â”œâ”€â”€ session-flow.spec.ts
â”‚   â”œâ”€â”€ routing.spec.ts
â”‚   â”œâ”€â”€ persistence.spec.ts
â”‚   â”œâ”€â”€ modals.spec.ts
â”‚   â”œâ”€â”€ early-submission.spec.ts
â”‚   â”œâ”€â”€ abandon.spec.ts
â”‚   â”œâ”€â”€ audio.spec.ts
â”‚   â”œâ”€â”€ export.spec.ts
â”‚   â””â”€â”€ responsive.spec.ts
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ bootstrap.sh
â”‚   â”œâ”€â”€ activate
â”‚   â””â”€â”€ serve.ts
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ playwright.config.ts
â””â”€â”€ README.md
```

---

## Core Engine Modules

| Module       | Responsibility                                                     |
| ------------ | ------------------------------------------------------------------ |
| `types.ts`   | Type definitions (Phase, Event, Session, Problem, Config, Summary) |
| `session.ts` | State machine, event dispatch, phase transitions, validation       |
| `presets.ts` | Preset configurations (Standard, HighPressure, NoAssistance)       |
| `index.ts`   | Public API exports                                                 |

---

## Web App Modules

| Module        | Responsibility                                      |
| ------------- | --------------------------------------------------- |
| `main.ts`     | Entry point, initializes router and storage         |
| `app.ts`      | Main controller, wires core engine to UI            |
| `router.ts`   | Hash-based client-side routing with session IDs     |
| `storage.ts`  | IndexedDB wrapper for sessions and audio            |
| `audio.ts`    | MediaRecorder wrapper, cross-browser format support |
| `tar.ts`      | Minimal TAR file writer (USTAR format)              |
| `export.ts`   | Export as .tar.gz using native CompressionStream    |
| `problems.ts` | Hardcoded problem set                               |

---

## UI Architecture

### Design Decisions

| Decision            | Choice                                             | Rationale                                                                                  |
| ------------------- | -------------------------------------------------- | ------------------------------------------------------------------------------------------ |
| Framework           | Vanilla JS                                         | Smaller bundle (~100KB vs ~255KB), no build complexity, aligns with local-first philosophy |
| UI organization     | Screen Modules + Reusable Components               | Reusability without framework overhead                                                     |
| Screen lifecycle    | `render(state)`, `mount(session)`, `unmount()`     | Clear lifecycle, similar to React patterns                                                 |
| ID/class management | Constants + Data Attributes                        | Prevents typos, separates JS hooks from CSS                                                |
| Modals              | Separate modules with `show(callbacks)` / `hide()` | Reusable, layered rendering                                                                |

### Screen Module Pattern

Each screen exports three functions:

```javascript
// ui/screens/StartScreen.js
import { ACTIONS, sel } from '../constants.js';

export function render(state) {
  return `
    <div class="screen start-screen">
      <button data-action="${ACTIONS.START_SESSION}" class="primary-btn">
        Start Session
      </button>
    </div>
  `;
}

export function mount(session) {
  document.querySelector(sel.action(ACTIONS.START_SESSION))
    .addEventListener('click', () => {
      session.dispatch('session.started', { problem });
    });
}

export function unmount() {
  // Cleanup if needed
}
```

### Reusable Components

Components are functions that return HTML strings:

```javascript
// ui/components/Timer.js
export function Timer(remainingTime, phase) {
  const minutes = Math.floor(remainingTime / 60000);
  const seconds = Math.floor((remainingTime % 60000) / 1000);
  const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;

  return `
    <div class="timer" data-component="timer" data-phase="${phase}">
      <span class="timer-display">${display}</span>
    </div>
  `;
}
```

Screens compose components:

```javascript
// ui/screens/CodingScreen.js
import { Timer } from '../components/Timer.js';
import { ProblemCard } from '../components/ProblemCard.js';
import { CodeEditor } from '../components/CodeEditor.js';

export function render(state) {
  return `
    <div class="screen coding-screen">
      ${Timer(state.remainingTime, 'coding')}
      ${ProblemCard(state.problem, true)}
      ${CodeEditor(state.code)}
    </div>
  `;
}
```

### Constants & Selectors

Centralized constants prevent string typos:

```javascript
// ui/constants.js
export const ACTIONS = {
  START_SESSION: 'start-session',
  START_CODING: 'start-coding',
  REQUEST_NUDGE: 'request-nudge',
  DOWNLOAD_BUNDLE: 'download-bundle',
  NEW_SESSION: 'new-session',
  RESUME: 'resume',
  ABANDON: 'abandon',
};

export const COMPONENTS = {
  TIMER: 'timer',
  CODE_EDITOR: 'code-editor',
  INVARIANTS_INPUT: 'invariants-input',
  PROBLEM_CARD: 'problem-card',
};

export const sel = {
  action: (name) => `[data-action="${name}"]`,
  component: (name) => `[data-component="${name}"]`,
};
```

### Modal Pattern

Modals render to a dedicated container:

```javascript
// ui/modals/ResumeModal.js
import { ACTIONS, sel } from '../constants.js';

export function show(onResume, onAbandon) {
  const root = document.getElementById('modal-root');
  root.innerHTML = `
    <div class="modal-overlay">
      <div class="modal">
        <h2>Session in progress</h2>
        <button data-action="${ACTIONS.RESUME}">Resume</button>
        <button data-action="${ACTIONS.ABANDON}">Abandon</button>
      </div>
    </div>
  `;
  root.classList.remove('hidden');

  document.querySelector(sel.action(ACTIONS.RESUME))
    .addEventListener('click', () => { hide(); onResume(); });
  document.querySelector(sel.action(ACTIONS.ABANDON))
    .addEventListener('click', () => { hide(); onAbandon(); });
}

export function hide() {
  const root = document.getElementById('modal-root');
  root.innerHTML = '';
  root.classList.add('hidden');
}
```

### Reusable Components List

| Component            | Used In                 | Props                       |
| -------------------- | ----------------------- | --------------------------- |
| `Timer`              | Prep, Coding, Silent    | `remainingTime`, `phase`    |
| `Header`             | All screens             | `title`, `rightContent`     |
| `ProblemCard`        | Prep, Coding, Silent    | `problem`, `collapsible`    |
| `CodeEditor`         | Coding, Silent, Summary | `code`, `readonly`          |
| `InvariantsInput`    | Prep                    | `value`                     |
| `InvariantsDisplay`  | Coding, Silent, Summary | `invariants`                |
| `NudgeButton`        | Coding, Silent          | `remaining`, `disabled`     |
| `RecordingIndicator` | Coding, Silent          | `active`                    |
| `Button`             | All screens             | `text`, `action`, `variant` |

---

## UX Wireframes

### Screen 1: Start

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                             â”‚
â”‚                                                             â”‚
â”‚                                                             â”‚
â”‚                    INTERVIEW CONDITIONING                   â”‚
â”‚                          STUDIO                             â”‚
â”‚                                                             â”‚
â”‚                                                             â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚                  â”‚   Start Session     â”‚                    â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                             â”‚
â”‚                                                             â”‚
â”‚              45 min â€¢ No tests â€¢ No hints                   â”‚
â”‚                                                             â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Screen 2: Prep Phase

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PREP                                            â± 4:32     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ TWO SUM                                             â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚ Given an array of integers nums and an integer      â”‚    â”‚
â”‚  â”‚ target, return indices of the two numbers such      â”‚    â”‚
â”‚  â”‚ that they add up to target.                         â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚ You may assume that each input would have exactly   â”‚    â”‚
â”‚  â”‚ one solution, and you may not use the same element  â”‚    â”‚
â”‚  â”‚ twice.                                              â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚ You can return the answer in any order.             â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â”‚  INVARIANTS                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ # Assumptions:                                      â”‚    â”‚
â”‚  â”‚ # - Array has at least 2 elements                   â”‚    â”‚
â”‚  â”‚ # - Exactly one valid solution exists               â”‚    â”‚
â”‚  â”‚ # - Cannot use same index twice                     â”‚    â”‚
â”‚  â”‚ #                                                   â”‚    â”‚
â”‚  â”‚ # Approach:                                         â”‚    â”‚
â”‚  â”‚ # - Use hashmap to store complement                 â”‚    â”‚
â”‚  â”‚ â”‚                                                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚                  â”‚   Start Coding  â†’   â”‚                    â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Screen 2b: Prep Timer Warning (Modal)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PREP                                            â± 0:00     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚      â”‚                                           â”‚          â”‚
â”‚      â”‚   âš   PREP TIME EXPIRED                    â”‚          â”‚
â”‚      â”‚                                           â”‚          â”‚
â”‚      â”‚   Moving to coding phase in 5 seconds...  â”‚          â”‚
â”‚      â”‚                                           â”‚          â”‚
â”‚      â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚          â”‚
â”‚      â”‚        â”‚  Start Coding Now    â”‚           â”‚          â”‚
â”‚      â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚          â”‚
â”‚      â”‚                                           â”‚          â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Screen 3: Coding Phase

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CODING                                         â± 28:14     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€ Problem â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[âˆ’]â”  â”‚
â”‚  â”‚ TWO SUM                                               â”‚  â”‚
â”‚  â”‚ Given an array of integers nums and an integer...     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€ Invariants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ # Assumptions: Array has at least 2 elements...        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€ Code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ def two_sum(nums, target):                             â”‚ â”‚
â”‚  â”‚     seen = {}                                          â”‚ â”‚
â”‚  â”‚     for i, num in enumerate(nums):                     â”‚ â”‚
â”‚  â”‚         complement = target - num                      â”‚ â”‚
â”‚  â”‚         if complement in seen:                         â”‚ â”‚
â”‚  â”‚             return [seen[complement], i]               â”‚ â”‚
â”‚  â”‚         seen[num] = i                                  â”‚ â”‚
â”‚  â”‚     return []â”‚                                         â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚  â”‚  Request Nudge    â”‚  2 remaining                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                                                      ğŸ”´ REC â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Screen 4: Silent Phase

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ SILENT PHASE â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â± 3:42     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€ Problem â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[âˆ’]â”  â”‚
â”‚  â”‚ TWO SUM                                               â”‚  â”‚
â”‚  â”‚ Given an array of integers nums and an integer...     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€ Invariants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ # Assumptions: Array has at least 2 elements...        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€ Code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ def two_sum(nums, target):                             â”‚ â”‚
â”‚  â”‚     seen = {}                                          â”‚ â”‚
â”‚  â”‚     for i, num in enumerate(nums):                     â”‚ â”‚
â”‚  â”‚         complement = target - num                      â”‚ â”‚
â”‚  â”‚         if complement in seen:                         â”‚ â”‚
â”‚  â”‚             return [seen[complement], i]               â”‚ â”‚
â”‚  â”‚         seen[num] = i                                  â”‚ â”‚
â”‚  â”‚     return []                                          â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚  â”‚  â–‘â–‘ No Nudges â–‘â–‘  â”‚  SILENT                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                                                      ğŸ”´ REC â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Screen 5: Summary

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SESSION COMPLETE                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€ Statistics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚  Problem:        Two Sum                               â”‚ â”‚
â”‚  â”‚  Total Time:     45:00                                 â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚  Prep:           4:28                                  â”‚ â”‚
â”‚  â”‚  Coding:         35:00                                 â”‚ â”‚
â”‚  â”‚  Silent:         5:00                                  â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚  Nudges Used:    1 / 3                                 â”‚ â”‚
â”‚  â”‚  Code Changes:   47                                    â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€ Invariants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ # Assumptions: Array has at least 2 elements           â”‚ â”‚
â”‚  â”‚ # Exactly one valid solution exists...                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€ Final Code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ def two_sum(nums, target):                             â”‚ â”‚
â”‚  â”‚     seen = {}                                          â”‚ â”‚
â”‚  â”‚     ...                                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  Download Bundle    â”‚    â”‚   New Session       â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Export Bundle Structure

```
{problem-slug}-{YYYY-MM-DD}.tar.gz
â”‚
â”œâ”€â”€ session.json      # Structured data for LLM analysis
â”œâ”€â”€ code.txt          # Final code snapshot
â”œâ”€â”€ invariants.txt    # User's invariants
â””â”€â”€ audio.webm        # Voice recording (optional, .m4a on Safari)
```

The export uses native browser APIs:

- **TAR format**: Minimal USTAR implementation (~80 lines)
- **Gzip compression**: Native `CompressionStream('gzip')` API
- **No external dependencies**: No JSZip or other libraries needed

### session.json

Structured data optimized for LLM analysis:

```json
{
  "id": "k5x2m9",
  "version": "1.0",
  "status": "completed",
  "preset": "Standard",
  "problem": {
    "id": "two-sum",
    "title": "Two Sum",
    "description": "Given an array of integers..."
  },
  "config": {
    "prepDurationMs": 300000,
    "codingDurationMs": 2100000,
    "silentDurationMs": 300000,
    "nudgeBudget": 3
  },
  "reflection": {
    "clearApproach": "partially",
    "prolongedStall": "yes",
    "recoveredFromStall": "yes",
    "timePressure": "manageable",
    "wouldChangeApproach": "yes"
  },
  "events": [
    { "type": "session.started", "timestamp": 1234567890, "data": {} },
    { "type": "prep.invariants_changed", "timestamp": 1234567900, "data": { "invariants": "..." } },
    { "type": "coding.started", "timestamp": 1234568000, "data": {} }
  ]
}
```

---

## Key Behaviors

- **Audio permission**: Requested on app load; if denied, continue without audio and show indicator
- **Nudge button**: Logs `nudge.requested` event, decrements counter, shows nothing to user (they talk through it)
- **Prep expiry**: Warning modal, then auto-transition to CODING after 5 seconds
- **Empty invariants**: Allowed; flagged in session.json and noted in summary observations
- **SILENT phase**: Visual indicator (e.g., banner, color shift), nudge button disabled
- **Audio recording**: Starts at CODING phase, stops at SUMMARY
- **Persistence**: Session saved to IndexedDB on every state change, restored on page load
- **Session completion**: phase='DONE' after reflection; skip resume modal on reload, show done screen directly
- **Problem selection**: Random from hardcoded set; repeats allowed
- **Export**: Downloads `session-{id}.zip` containing session.json, reflection.json, code.py, invariants.txt, audio.webm, summary.md, problem.md, prompt.md
- **Reflection**: Mandatory after summary; 5 recognition-based prompts; cannot be skipped

---

## Reflection Phase

Reflection is mandatory and occurs after the summary screen. It captures structured self-assessment data.

### Reflection Prompts

| #   | Prompt                                                     | Response Type                           |
| --- | ---------------------------------------------------------- | --------------------------------------- |
| 1   | Did you have a clear approach before coding?               | Yes / Partially / No                    |
| 2   | Did you experience a prolonged stall?                      | Yes / No                                |
| 3   | Did you recover after getting stuck?                       | Yes / Partially / No / N/A              |
| 4   | How did the time pressure feel?                            | Comfortable / Manageable / Overwhelming |
| 5   | Would you change how you approached the problem next time? | Yes / No                                |

### Design Principles

- **Recognition-based**: All responses are selection-based, not free text
- **Low cognitive load**: ~60 seconds to complete
- **Behavioral anchoring**: Questions target observable behaviors, not feelings about correctness
- **No judgment**: Responses are recorded, not evaluated

### Reflection Data Model

```json
{
  "completedAt": 1234567890,
  "responses": {
    "clearApproach": "yes" | "partially" | "no",
    "prolongedStall": "yes" | "no",
    "recoveredFromStall": "yes" | "partially" | "no" | "n/a",
    "timePressure": "comfortable" | "manageable" | "overwhelming",
    "wouldChangeApproach": "yes" | "no"
  }
}
```

### Response Validation

1. **Exact value matching:** All response values must match the exact allowed values shown in the data model above
2. **Event rejection:** Invalid values cause the `reflection.submitted` event to be rejected (not appended to log)
3. **Return value semantics:** `dispatch()` returns `null` when an event is rejected, returns the created `Event` object on success
4. **Conditional field:** The `recoveredFromStall` field accepts `"n/a"` only when `prolongedStall` is `"no"`

---

## Session Status

Sessions have one of three statuses:

| Status                | Description                                                                                     |
| --------------------- | ----------------------------------------------------------------------------------------------- |
| `in_progress`         | Session is currently active (not yet completed or abandoned)                                    |
| `completed`           | Session finished normally (all phases including reflection)                                     |
| `abandoned_explicit`  | User explicitly clicked "Abandon" in resume modal                                               |
| `incomplete_inferred` | Session started but not completed (detected and applied by web layer on restore from IndexedDB) |

> **Note:** The core engine tracks `in_progress`, `completed`, and `abandoned_explicit`. The `incomplete_inferred` status is detected and applied by the web layer when restoring a session from IndexedDB that was never completed.

### MVP Behavior

- **Surfaced in UI**: `completed` and `abandoned_explicit` only
- **Recorded silently**: `incomplete_inferred` (for future analysis)
- **No penalty**: Incomplete sessions are not judged; crashes/refreshes don't count as abandonment

---

## Core vs Web Responsibilities

| Feature                         | Owner | Rationale                                   |
| ------------------------------- | ----- | ------------------------------------------- |
| State machine & transitions     | Core  | Testable, deterministic                     |
| Event log (append, replay)      | Core  | Source of truth                             |
| Derived metrics & flags         | Core  | Computed from events                        |
| Audio events logging            | Core  | Records `audio.*` events                    |
| `isRecording` state             | Core  | Derived from audio events                   |
| MediaRecorder management        | Web   | Browser API                                 |
| Timer UI & countdown            | Web   | Polls `remainingTime`, dispatches on expiry |
| Phase auto-transition dispatch  | Web   | UI controls timing UX                       |
| IndexedDB persistence           | Web   | Browser storage                             |
| `incomplete_inferred` detection | Web   | Applied on restore from storage             |
| Export bundle generation        | Web   | File I/O, JSZip                             |

---

## Behavioral Signals

The system captures objective behavioral signals for self-review and historical comparison.

### Signals Captured

| Signal               | Description                            | Derived From                                             |
| -------------------- | -------------------------------------- | -------------------------------------------------------- |
| Prep time used       | Time spent in PREP phase               | `coding.started` timestamp - `session.started` timestamp |
| Nudges used          | Count of nudge requests                | `nudge.requested` event count                            |
| Nudge timing         | When nudges were used (early/mid/late) | `nudge.requested` timestamps relative to coding phase    |
| Code change count    | Number of code edits                   | `coding.code_changed` event count                        |
| Phase overrun        | Whether user exceeded phase time       | Computed from phase timestamps                           |
| Explicit abandonment | User clicked "Abandon"                 | `session.abandoned` event                                |

### Historical Comparison (Start Screen)

On the start screen, show deltas vs last completed session:

```
Last session: 2 nudges â€¢ 4:12 prep time
```

This provides context without judgment.

---

## Client-Side Routing

Hash-based routing with session IDs for bookmarkable URLs.

### Routes

| Hash                       | Screen            |
| -------------------------- | ----------------- |
| `#/`                       | Home screen       |
| `#/{sessionId}/prep`       | Prep phase        |
| `#/{sessionId}/coding`     | Coding phase      |
| `#/{sessionId}/silent`     | Silent phase      |
| `#/{sessionId}/summary`    | Summary screen    |
| `#/{sessionId}/reflection` | Reflection screen |
| `#/{sessionId}/done`       | Done screen       |

### URL Behavior

- **URL derives from state**: The URL reflects the current session state, not vice versa
- **Automatic redirects**: If URL mismatches session state, user is redirected to correct phase
- **Session not found**: Redirects to home with toast notification
- **Bookmarkable**: Users can bookmark and return to a session

---

## State Management (Event-Sourced)

The system uses event sourcing for safe state mutation and querying.

### Pattern

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Event Log     â”‚ â”€â”€â”€â–º â”‚   Derived State (computed)   â”‚
â”‚   (append-only) â”‚      â”‚                              â”‚
â”‚                 â”‚      â”‚   â€¢ currentPhase             â”‚
â”‚   â€¢ event 1     â”‚      â”‚   â€¢ remainingTime            â”‚
â”‚   â€¢ event 2     â”‚      â”‚   â€¢ nudgesRemaining          â”‚
â”‚   â€¢ event 3     â”‚      â”‚   â€¢ code (latest snapshot)   â”‚
â”‚   â€¢ ...         â”‚      â”‚   â€¢ invariants               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Single source of truth    Recomputed from events
```

### Key Principles

1. **State is never mutated directly** â€” only events are appended
2. **Mutation via `dispatch(eventType, data)`** â€” appends event, invalidates cache
3. **Query via `getState()`** â€” derives current state from event log (with caching)
4. **Deterministic** â€” same events always produce same state
5. **Recoverable** â€” replay events from storage to restore session

### Implementation

```javascript
class Session {
  constructor() {
    this.events = [];        // Append-only log
    this.listeners = [];     // Subscribed callbacks
    this._state = null;      // Cached derived state
    this._stateVersion = -1; // Cache invalidation
  }

  dispatch(eventType, data = {}) {
    // Validate event - returns null if invalid
    if (!this._isValidEvent(eventType, data)) {
      return null;
    }

    const event = {
      type: eventType,
      timestamp: Date.now(),
      data
    };
    this.events.push(event);
    this._stateVersion = -1; // Invalidate cache
    this._notifyListeners(event);
    return event;
  }

  subscribe(callback) {
    this.listeners.push(callback);
    // Return unsubscribe function
    return () => {
      this.listeners = this.listeners.filter(l => l !== callback);
    };
  }

  _notifyListeners(event) {
    const state = this.getState();
    for (const listener of this.listeners) {
      listener(event, state);
    }
  }

  getState() {
    if (this._stateVersion === this.events.length) {
      return this._state;
    }
    this._state = this._deriveState();
    this._stateVersion = this.events.length;
    return this._state;
  }

  _deriveState() {
    // Replay events to compute current state
    // ...
  }
}
```

---

## Event Flow

Components communicate through the session's event system:

### Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Event Dispatch                              â”‚
â”‚                                                                     â”‚
â”‚   UI Action (click, input)                                          â”‚
â”‚         â”‚                                                           â”‚
â”‚         â–¼                                                           â”‚
â”‚   session.dispatch('event.type', { data })                          â”‚
â”‚         â”‚                                                           â”‚
â”‚         â–¼                                                           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚                    Session                               â”‚       â”‚
â”‚   â”‚  1. Append event to log                                  â”‚       â”‚
â”‚   â”‚  2. Invalidate cached state                              â”‚       â”‚
â”‚   â”‚  3. Notify all listeners                                 â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                                                           â”‚
â”‚         â–¼                                                           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚              Listeners (subscribed callbacks)            â”‚       â”‚
â”‚   â”‚                                                          â”‚       â”‚
â”‚   â”‚  storage.js  â†’ saveSession(), saveAudioChunks()          â”‚       â”‚
â”‚   â”‚  audio.js    â†’ startRecording(), stopRecording()         â”‚       â”‚
â”‚   â”‚  app.js      â†’ renderCurrentScreen(), navigate()         â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Side Effect Co-location

Side effects are handled by the module responsible for that concern:

```javascript
// storage.js â€” subscribes to persist on any event
session.subscribe((event, state) => {
  saveSession(session.serialize());
  if (event.type === 'coding.code_changed') {
    saveAudioChunks(state.id, audioChunks);
  }
});

// audio.js â€” subscribes to control recording
session.subscribe((event, state) => {
  if (event.type === 'coding.started') {
    startRecording();
  }
  if (event.type === 'session.ended') {
    stopRecording();
  }
});

// app.js â€” subscribes to update UI
session.subscribe((event, state) => {
  renderCurrentScreen(state);
  if (state.phase !== currentPhase) {
    navigate('/' + state.phase.toLowerCase());
    currentPhase = state.phase;
  }
});
```

### Timer Handling

Timer display uses `setInterval` (not events) to avoid log bloat. Only phase transitions are events:

```javascript
// app.js â€” timer display loop
setInterval(() => {
  const state = session.getState();
  renderTimer(state.remainingTime);

  // Check for phase transitions
  if (state.phase === 'PREP' && state.remainingTime <= 0) {
    session.dispatch('prep.time_expired', {});
  }
  if (state.phase === 'CODING' && state.remainingTime <= 0) {
    session.dispatch('coding.silent_started', {});
  }
  if (state.phase === 'SILENT' && state.remainingTime <= 0) {
    session.dispatch('session.ended', {});
  }
}, 1000);
```

Time remaining is computed dynamically in `_deriveState()`:

```javascript
_deriveState() {
  // ... replay events to get phase start times ...

  const now = Date.now();
  if (state.phase === 'PREP') {
    state.remainingTime = PREP_DURATION - (now - state.prepStartTime);
  } else if (state.phase === 'CODING') {
    state.remainingTime = CODING_DURATION - (now - state.codingStartTime);
  } else if (state.phase === 'SILENT') {
    state.remainingTime = SILENT_DURATION - (now - state.silentStartTime);
  }

  return state;
}
```

### Event Types

| Event                     | When Dispatched                                           | Data                          |
| ------------------------- | --------------------------------------------------------- | ----------------------------- |
| `session.started`         | User clicks "Start Session"                               | `{ problem, preset, config }` |
| `prep.invariants_changed` | User types in invariants (debounced)                      | `{ invariants }`              |
| `prep.time_expired`       | Prep timer reaches 0                                      | `{}`                          |
| `coding.started`          | User clicks "Start Coding" or prep time forces transition | `{}`                          |
| `coding.code_changed`     | User types in code editor (debounced)                     | `{ code }`                    |
| `nudge.requested`         | User clicks "Request Nudge"                               | `{}`                          |
| `coding.silent_started`   | Coding timer reaches 0, entering silent phase             | `{}`                          |
| `silent.ended`            | Silent timer reaches 0, entering summary                  | `{}`                          |
| `summary.continued`       | User clicks "Continue" on summary screen                  | `{}`                          |
| `reflection.submitted`    | User completes reflection prompts                         | `{ responses }`               |
| `session.completed`       | Reflection submitted, session fully complete              | `{}`                          |
| `session.abandoned`       | User explicitly abandons session                          | `{}`                          |
| `audio.started`           | Audio recording begins                                    | `{}`                          |
| `audio.stopped`           | Audio recording ends                                      | `{}`                          |
| `audio.permission_denied` | User denies microphone permission                         | `{}`                          |

> **Note:** `session.completed` is auto-emitted by the core engine after `reflection.submitted` is processed. The caller only dispatches `reflection.submitted`; the engine handles emitting `session.completed`.

> **Audio Events Responsibility Split:**
>
> - **Core engine:** Accepts and logs `audio.*` events, tracks `isRecording` state (derived from events)
> - **Web layer:** Manages actual MediaRecorder API, dispatches events to core based on hardware state

---

## Storage (IndexedDB)

Using IndexedDB for all persistence (replaces localStorage). Benefits:

- **Non-blocking** â€” async API doesn't freeze UI
- **Large storage** â€” can store audio blobs (50MB+)
- **Native objects** â€” no JSON stringify/parse overhead
- **Full recovery** â€” sessions and audio can be restored on refresh

### Object Stores

| Store      | Key         | Contents                                           |
| ---------- | ----------- | -------------------------------------------------- |
| `sessions` | `id`        | Session object (events, problem, code, invariants) |
| `audio`    | `sessionId` | Audio chunks array (Blob[])                        |

### Wrapper API

```javascript
// storage.js
async function initStorage()
async function saveSession(session)
async function getSession(id)
async function getCurrentSession()
async function saveAudioChunks(sessionId, chunks)
async function getAudioChunks(sessionId)
async function clearSession(id)
```

---

## Session Recovery

### Tab Close Warning

Using `beforeunload` to warn users before leaving mid-session:

```javascript
window.addEventListener('beforeunload', (e) => {
  if (sessionInProgress()) {
    e.preventDefault();
    e.returnValue = '';
  }
});
```

Note: Browser shows generic message (cannot customize).

### Recovery Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Page Load                              â”‚
â”‚         â”‚                               â”‚
â”‚         â–¼                               â”‚
â”‚  await initStorage()                    â”‚
â”‚         â”‚                               â”‚
â”‚         â–¼                               â”‚
â”‚  existing = await getCurrentSession()   â”‚
â”‚         â”‚                               â”‚
â”‚         â”œâ”€â”€ null â”€â”€â”€â”€â”€â”€â–º Show Start     â”‚
â”‚         â”‚                               â”‚
â”‚         â””â”€â”€ exists â”€â”€â”€â–º Show Resume     â”‚
â”‚                         Modal           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Resume Modal

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                             â”‚
â”‚   Session in progress detected                              â”‚
â”‚                                                             â”‚
â”‚   Your code, invariants, and audio can be restored.         â”‚
â”‚                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚   â”‚   Resume    â”‚    â”‚   Abandon   â”‚                        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Export

### Flow

```
1. Collect data (code, invariants, events, reflection, audio blob)
           â”‚
           â–¼
2. Create TAR archive in memory
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  addFile("session.json", jsonString)       â”‚
   â”‚  addFile("code.txt", codeString)           â”‚
   â”‚  addFile("invariants.txt", invString)      â”‚
   â”‚  addFile("audio.webm", audioBlob)          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
3. Compress with gzip
   new CompressionStream('gzip')
           â”‚
           â–¼
4. Trigger download
   URL.createObjectURL(blob) + <a download>
           â”‚
           â–¼
5. Browser saves {problem-slug}-{date}.tar.gz
```

### Native APIs Used

- **TAR**: Custom minimal implementation (~80 lines, USTAR format)
- **Gzip**: Native `CompressionStream('gzip')` API
- **Download**: Blob URL + anchor click

---

## Design Decisions

| Decision             | Choice                                                  | Rationale                                                        |
| -------------------- | ------------------------------------------------------- | ---------------------------------------------------------------- |
| Session ID           | Short random (`Math.random().toString(36).slice(2, 8)`) | Human-readable, sufficient entropy for local app                 |
| Code change tracking | Debounced events (2-3s inactivity)                      | Captures intent without noise                                    |
| Timer display        | MM:SS format                                            | Clean, less stressful than showing milliseconds                  |
| Problem selection    | Pure random                                             | Simple for MVP; repeats expected with small problem set          |
| Error handling       | Graceful degradation                                    | Mic denied â†’ continue without audio; show user-friendly messages |

---

## Dependencies

| Package      | Purpose             | Where |
| ------------ | ------------------- | ----- |
| `typescript` | Type checking       | Dev   |
| `bun`        | Runtime and bundler | Dev   |
| `playwright` | E2E testing         | Dev   |
| `oxlint`     | Linting             | Dev   |
| `oxfmt`      | Formatting          | Dev   |

**No runtime dependencies.** The app uses native browser APIs for:

- IndexedDB (storage)
- MediaRecorder (audio)
- CompressionStream (gzip)
- Blob/URL APIs (file download)

---

## Test Strategy (TDD)

We follow a Test-Driven Development approach with BDD-style tests:

### Principles

1. **Tests first** â€” Write behavioral tests before implementation
2. **BDD style** â€” Tests organized by user workflows, not modules
3. **Exhaustive coverage** â€” Cover happy paths, edge cases, and error states
4. **Simple implementation** â€” Comprehensive tests force minimal, correct business logic

### Test Framework

- **Framework**: `bun:test` (built-in, no additional dependencies)
- **Style**: Describe/it blocks with clear workflow descriptions
- **Timer mocking**: Dependency injection via `createSession({ clock: () => mockTime })`

### Test File Structure

```
core/src/__tests__/
â”œâ”€â”€ session-lifecycle.test.ts   # Full session flow, state transitions
â”œâ”€â”€ prep-phase.test.ts          # Invariants, timer expiry, warnings
â”œâ”€â”€ coding-phase.test.ts        # Code changes, nudges, timer
â”œâ”€â”€ silent-phase.test.ts        # No nudges, continued coding
â”œâ”€â”€ reflection-phase.test.ts    # Mandatory reflection, prompts, responses
â”œâ”€â”€ recovery.test.ts            # Resume, abandon, state restoration
â”œâ”€â”€ summary.test.ts             # Metrics derivation from events
â””â”€â”€ history.test.ts             # Historical session storage, deltas
```

### Test Coverage Goals

Each workflow covers:

- **Happy path** â€” Normal user flow
- **Edge cases** â€” Boundary conditions (timer at 0, empty invariants, etc.)
- **Error states** â€” Invalid transitions, budget exhaustion
- **Recovery scenarios** â€” Mid-session restore, partial state

### Development Workflow

1. Draft test file for a workflow â†’ Review â†’ Approval
2. Implement core engine to pass tests
3. Repeat for remaining workflows
4. Web integration tests after core engine is complete

---

## Implementation Order

| #   | Task                                 | Scope   |
| --- | ------------------------------------ | ------- |
| 1   | Core types & event log               | `core/` |
| 2   | Session state machine                | `core/` |
| 3   | Timer logic                          | `core/` |
| 4   | Nudge system                         | `core/` |
| 5   | Summary generator                    | `core/` |
| 6   | Build setup (tsconfig, package.json) | `core/` |
| 7   | HTML structure & CSS                 | `web/`  |
| 8   | Router (hash-based)                  | `web/`  |
| 9   | UI constants & utilities             | `web/`  |
| 10  | Reusable components                  | `web/`  |
| 11  | Screen modules                       | `web/`  |
| 12  | Modals                               | `web/`  |
| 13  | App controller (app.js)              | `web/`  |
| 14  | Hardcoded problems                   | `web/`  |
| 15  | Audio recording                      | `web/`  |
| 16  | IndexedDB storage                    | `web/`  |
| 17  | Session recovery flow                | `web/`  |
| 18  | Zip export                           | `web/`  |
| 19  | Integration & testing                | All     |

---

## Development

### Prerequisites

- Bun (JavaScript runtime and bundler)

### Commands

```bash
./scripts/bootstrap.sh   # Install bun and dependencies
source scripts/activate  # Activate environment
bun run dev              # Build + start server at localhost:8000
bun run build            # Build bundle
bun run test             # Run unit tests
bun run test:e2e         # Run E2E tests
bun run ci               # Full CI pipeline
```

### Dev Workflow

1. Edit TypeScript in `core/src/` or `web/src/`
2. Run `bun run build` to rebuild
3. Refresh browser at http://localhost:8000
